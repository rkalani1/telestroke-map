<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Telestroke Network Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet.awesome-markers CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" integrity="sha512-cUoWMYm82LICHZ/D1S/VdtpKBcVSNbr0DkT8s0jGWrL3qPGOv6mG+T/w1a/s/FAmJ/S/LccSiv/N/lGzOwTgNQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet.js -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet.awesome-markers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js" integrity="sha512-8I8guQ2iZS9x2scTdeUAiNsROM/UPEGSFpEwRNoafMO1S/WjEaVm/aGvTqOMGnIluXSHyYkAXvY/92P/scrcmA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* Set map to full screen */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        #map { height: 100vh; width: 100vw; z-index: 10; }

        /* Ensure filter panel is on top */
        #filter-panel { z-index: 1000; }

        /* Fix for Leaflet popups being unstyled by default w/ Tailwind */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: white;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            border-radius: 8px;
            padding: 4px;
        }
        .leaflet-popup-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            font-size: 14px;
            line-height: 1.6;
        }
        .popup-tbd {
            color: #9ca3af; /* text-gray-400 */
            font-style: italic;
        }

        /* Permanent label styling */
        .leaflet-tooltip.hospital-label {
            background-color: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid #333 !important;
            border-radius: 4px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            padding: 3px 7px !important;
            white-space: nowrap !important;
            color: #333 !important;
            opacity: 1 !important;
            pointer-events: none !important;
        }
        .leaflet-tooltip.hospital-label::before {
            display: none !important;
        }
        .leaflet-tooltip-left.hospital-label::before {
            display: none !important;
        }
        .leaflet-tooltip-right.hospital-label::before {
            display: none !important;
        }
    </style>
</head>
<body class="font-sans">

    <!-- The Map Container -->
    <div id="map"></div>

    <!-- The Filter & Legend UI Panel -->
    <div id="filter-panel" class="absolute top-4 right-4 bg-white p-4 rounded-lg shadow-lg max-w-xs w-full border border-gray-200 max-h-[95vh] overflow-y-auto">
        <h3 class="text-lg font-bold mb-3 text-gray-800 border-b pb-2">Strategy Filters</h3>

        <!-- Section 1: Layer Toggles -->
        <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Toggle Layers</h4>
            <div class="space-y-1">
                <div>
                    <input type="checkbox" id="cah-toggle" class="form-checkbox h-4 w-4 text-blue-600 rounded" checked>
                    <label for="cah-toggle" class="ml-2 text-sm text-gray-700"><i class="fa fa-circle text-blue-600"></i> Critical Access (CAH)</label>
                </div>
                <div>
                    <input type="checkbox" id="acute-toggle" class="form-checkbox h-4 w-4 text-gray-600 rounded" checked>
                    <label for="acute-toggle" class="ml-2 text-sm text-gray-700"><i class="fa fa-map-pin text-gray-600"></i> Acute Care (Non-CAH)</label>
                </div>
                <div>
                    <input type="checkbox" id="psc-toggle" class="form-checkbox h-4 w-4 text-red-800 rounded" checked>
                    <label for="psc-toggle" class="ml-2 text-sm text-gray-700"><i class="fa fa-star text-red-800"></i> Primary Stroke (PSC)</label>
                </div>
                <div>
                    <input type="checkbox" id="csc-toggle" class="form-checkbox h-4 w-4 text-purple-600 rounded" checked>
                    <label for="csc-toggle" class="ml-2 text-sm text-gray-700"><i class="fa fa-star text-purple-600"></i> Comprehensive (CSC)</label>
                </div>
            </div>
        </div>

        <!-- Section 2: Affiliation Filter -->
        <div class="mb-4">
            <label for="affiliation-filter" class="block font-semibold text-gray-700 mb-2">Telestroke Affiliation</label>
            <select id="affiliation-filter" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                <option value="all">Show All</option>
                <option value="TBD">Unaffiliated / TBD</option>
                <option value="UW Medicine">UW Medicine</option>
                <option value="Competitor">Competitor Affiliated</option>
            </select>
        </div>

        <!-- Section 3: Capability Filters -->
        <div class="mb-2">
             <h4 class="font-semibold text-gray-700 mb-2">Filter by Capability</h4>
             <div class="space-y-1">
                <div>
                    <input type="checkbox" id="helipad-filter" class="form-checkbox h-4 w-4 text-gray-600 rounded">
                    <label for="helipad-filter" class="ml-2 text-sm text-gray-700">Has Helipad (TBD)</label>
                </div>
                <div>
                    <input type="checkbox" id="ct-filter" class="form-checkbox h-4 w-4 text-gray-600 rounded">
                    <label for="ct-filter" class="ml-2 text-sm text-gray-700">Has 24/7 CT (TBD)</label>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT -->
    <script>
        // --- 1. DATA ---
        // This is the complete, verified dataset.

        const harborviewCoords = { lat: 47.604, lon: -122.325 };

        // 39 Critical Access Hospitals (CAH) in WA
        const hospitalData = [
            { name: "Arbor Health, Morton Hospital", city: "Morton, WA", lat: 46.557, lon: -122.28, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Astria Sunnyside Hospital", city: "Sunnyside, WA", lat: 46.326, lon: -120.005, type: "CAH", affiliation: "Astria Health", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Cascade Medical Center", city: "Leavenworth, WA", lat: 47.595, lon: -120.66, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Columbia Basin Hospital", city: "Ephrata, WA", lat: 47.316, lon: -119.539, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Columbia County Health System", city: "Dayton, WA", lat: 46.319, lon: -117.973, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Coulee Medical Center", city: "Grand Coulee, WA", lat: 47.939, lon: -118.983, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "East Adams Rural Healthcare", city: "Ritzville, WA", lat: 47.126, lon: -118.384, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Ferry County Memorial Hospital", city: "Republic, WA", lat: 48.65, lon: -118.729, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Forks Community Hospital", city: "Forks, WA", lat: 47.949, lon: -124.383, type: "CAH", affiliation: "Independent", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Garfield County Hospital District", city: "Pomeroy, WA", lat: 46.471, lon: -117.595, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Island Health", city: "Anacortes, WA", lat: 48.498, lon: -122.61, type: "CAH", affiliation: "Independent", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Jefferson Healthcare", city: "Port Townsend, WA", lat: 48.106, lon: -122.784, type: "CAH", affiliation: "Independent", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Kittitas Valley Healthcare", city: "Ellensburg, WA", lat: 46.992, lon: -120.536, type: "CAH", affiliation: "Independent", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Klickitat Valley Health", city: "Goldendale, WA", lat: 45.819, lon: -120.819, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Lake Chelan Community Hospital", city: "Chelan, WA", lat: 47.837, lon: -120.034, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Lincoln Hospital", city: "Davenport, WA", lat: 47.653, lon: -118.151, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Lourdes Medical Center", city: "Pasco, WA", lat: 46.234, lon: -119.098, type: "CAH", affiliation: "ScionHealth", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Mason Health", city: "Shelton, WA", lat: 47.227, lon: -123.114, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Mid-Valley Hospital", city: "Omak, WA", lat: 48.423, lon: -119.516, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Newport Hospital & Health Services", city: "Newport, WA", lat: 48.179, lon: -117.042, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "North Valley Hospital", city: "Tonasket, WA", lat: 48.718, lon: -119.439, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Ocean Beach Hospital", city: "Ilwaco, WA", lat: 46.309, lon: -124.041, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Odessa Memorial Healthcare Center", city: "Odessa, WA", lat: 47.334, lon: -118.686, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Olympic Medical Center", city: "Port Angeles, WA", lat: 48.11, lon: -123.456, type: "CAH", affiliation: "Independent", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Othello Community Hospital", city: "Othello, WA", lat: 46.822, lon: -119.162, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "PeaceHealth Peace Island Medical Center", city: "Friday Harbor, WA", lat: 48.53, lon: -123.03, type: "CAH", affiliation: "PeaceHealth", telestrokePartner: "PeaceHealth", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "PeaceHealth United General Medical Center", city: "Sedro-Woolley, WA", lat: 48.508, lon: -122.234, type: "CAH", affiliation: "PeaceHealth", telestrokePartner: "PeaceHealth", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Prosser Memorial Health", city: "Prosser, WA", lat: 46.21, lon: -119.778, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Providence Mount Carmel Hospital", city: "Colville, WA", lat: 48.555, lon: -117.892, type: "CAH", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Providence St. Joseph's Hospital", city: "Chewelah, WA", lat: 48.278, lon: -117.712, type: "CAH", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Pullman Regional Hospital", city: "Pullman, WA", lat: 46.737, lon: -117.155, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Quincy Valley Medical Center", city: "Quincy, WA", lat: 47.234, lon: -119.865, type: "CAH", affiliation: "Independent", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Samaritan Healthcare", city: "Moses Lake, WA", lat: 47.117, lon: -119.263, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Skyline Health", city: "White Salmon, WA", lat: 45.735, lon: -121.492, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Snoqualmie Valley Hospital", city: "Snoqualmie, WA", lat: 47.525, lon: -121.821, type: "CAH", affiliation: "Independent", telestrokePartner: "Swedish", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Elizabeth Hospital", city: "Enumclaw, WA", lat: 47.202, lon: -121.986, type: "CAH", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Summit Pacific Medical Center", city: "Elma, WA", lat: 47.004, lon: -123.431, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Three Rivers Hospital", city: "Brewster, WA", lat: 48.093, lon: -119.768, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Tri-State Memorial Hospital", city: "Clarkston, WA", lat: 46.401, lon: -117.065, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "WhidbeyHealth Medical Center", city: "Coupeville, WA", lat: 48.203, lon: -122.656, type: "CAH", affiliation: "Independent", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Whitman Hospital & Medical Clinics", city: "Colfax, WA", lat: 46.883, lon: -117.362, type: "CAH", affiliation: "Independent", telestrokePartner: "Providence", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Willapa Harbor Hospital", city: "South Bend, WA", lat: 46.666, lon: -123.805, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            // 8 CAHs in Northern ID
            { name: "Benewah Community Hospital", city: "St. Maries, ID", lat: 47.311, lon: -116.565, type: "CAH", affiliation: "Independent", telestrokePartner: "Kootenai Health", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Bonner General Hospital", city: "Sandpoint, ID", lat: 48.271, lon: -116.551, type: "CAH", affiliation: "Independent", telestrokePartner: "Kootenai Health", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Boundary Community Hospital", city: "Bonners Ferry, ID", lat: 48.694, lon: -116.319, type: "CAH", affiliation: "Independent", telestrokePartner: "Kootenai Health", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Clearwater Valley Hospital", city: "Orofino, ID", lat: 46.483, lon: -116.257, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Gritman Medical Center", city: "Moscow, ID", lat: 46.732, lon: -117.001, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Shoshone Medical Center", city: "Kellogg, ID", lat: 47.54, lon: -116.126, type: "CAH", affiliation: "Independent", telestrokePartner: "Kootenai Health", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Mary's Hospital", city: "Cottonwood, ID", lat: 46.059, lon: -116.349, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Syringa General Hospital", city: "Grangeville, ID", lat: 45.927, lon: -116.128, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            // 4 CAHs in SE Alaska
            { name: "SEARHC Mt. Edgecumbe Medical Center", city: "Sitka, AK", lat: 57.051, lon: -135.353, type: "CAH", affiliation: "SEARHC", telestrokePartner: "TBD", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Petersburg Medical Center", city: "Petersburg, AK", lat: 56.81, lon: -132.966, type: "CAH", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "SEARHC Wrangell Medical Center", city: "Wrangell, AK", lat: 56.477, lon: -132.38, type: "CAH", affiliation: "SEARHC", telestrokePartner: "TBD", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "PeaceHealth Ketchikan Medical Center", city: "Ketchikan, AK", lat: 55.356, lon: -131.67, type: "CAH", affiliation: "PeaceHealth", telestrokePartner: "PeaceHealth", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" }
        ];

        // 43 Other Acute Care Hospitals (Non-CAH) in WA & N-ID
        const acuteCareData = [
            // WA
            { name: "Providence Regional Medical Center Everett", city: "Everett, WA", lat: 47.962, lon: -122.20, type: "AcuteCare", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "MultiCare Tacoma General Hospital", city: "Tacoma, WA", lat: 47.251, lon: -122.454, type: "AcuteCare", affiliation: "MultiCare", telestrokePartner: "MultiCare", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "PeaceHealth St. Joseph Medical Center", city: "Bellingham, WA", lat: 48.77, lon: -122.464, type: "AcuteCare", affiliation: "PeaceHealth", telestrokePartner: "PeaceHealth", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Providence St. Peter Hospital", city: "Olympia, WA", lat: 47.017, lon: -122.883, type: "AcuteCare", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Virginia Mason Medical Center", city: "Seattle, WA", lat: 47.608, lon: -122.325, type: "AcuteCare", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "MultiCare Deaconess Hospital", city: "Spokane, WA", lat: 47.653, lon: -117.43, type: "AcuteCare", affiliation: "MultiCare", telestrokePartner: "MultiCare", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Confluence Health Hospital | Central Campus", city: "Wenatchee, WA", lat: 47.419, lon: -120.323, type: "AcuteCare", affiliation: "Confluence Health", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Kadlec Regional Medical Center", city: "Richland, WA", lat: 46.29, lon: -119.288, type: "AcuteCare", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "MultiCare Capital Medical Center", city: "Olympia, WA", lat: 47.042, lon: -122.946, type: "AcuteCare", affiliation: "MultiCare", telestrokePartner: "MultiCare", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "MultiCare Good Samaritan Hospital", city: "Puyallup, WA", lat: 47.172, lon: -122.285, type: "AcuteCare", affiliation: "MultiCare", telestrokePartner: "MultiCare", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Overlake Medical Center", city: "Bellevue, WA", lat: 47.616, lon: -122.18, type: "AcuteCare", affiliation: "Overlake", telestrokePartner: "TBD", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Providence Centralia Hospital", city: "Centralia, WA", lat: 46.723, lon: -122.955, type: "AcuteCare", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Skagit Valley Hospital", city: "Mount Vernon, WA", lat: 48.435, lon: -122.327, type: "AcuteCare", affiliation: "Skagit Regional Health", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Anne Hospital", city: "Burien, WA", lat: 47.469, lon: -122.348, type: "AcuteCare", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Anthony Hospital", city: "Gig Harbor, WA", lat: 47.348, lon: -122.605, type: "AcuteCare", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Clare Hospital", city: "Lakewood, WA", lat: 47.168, lon: -122.521, type: "AcuteCare", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Francis Hospital", city: "Federal Way, WA", lat: 47.31, lon: -122.31, type: "AcuteCare", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Joseph Medical Center", city: "Tacoma, WA", lat: 47.242, lon: -122.441, type: "AcuteCare", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Michael Medical Center", city: "Silverdale, WA", lat: 47.643, lon: -122.686, type: "AcuteCare", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Swedish Edmonds", city: "Edmonds, WA", lat: 47.811, lon: -122.33, type: "AcuteCare", affiliation: "Swedish", telestrokePartner: "Swedish", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Swedish Issaquah", city: "Issaquah, WA", lat: 47.54, lon: -122.067, type: "AcuteCare", affiliation: "Swedish", telestrokePartner: "Swedish", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Trios Health", city: "Kennewick, WA", lat: 46.195, lon: -119.208, type: "AcuteCare", affiliation: "ScionHealth", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "UW Medical Center - Montlake", city: "Seattle, WA", lat: 47.649, lon: -122.308, type: "AcuteCare", affiliation: "UW Medicine", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "UW Medical Center - Northwest", city: "Seattle, WA", lat: 47.705, lon: -122.332, type: "AcuteCare", affiliation: "UW Medicine", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "UW Medicine Valley Medical Center", city: "Renton, WA", lat: 47.452, lon: -122.206, type: "AcuteCare", affiliation: "UW Medicine", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Walla Walla General Hospital", city: "Walla Walla, WA", lat: 46.069, lon: -118.307, type: "AcuteCare", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "MultiCare Auburn Medical Center", city: "Auburn, WA", lat: 47.302, lon: -122.213, type: "AcuteCare", affiliation: "MultiCare", telestrokePartner: "MultiCare", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "MultiCare Covington Medical Center", city: "Covington, WA", lat: 47.359, lon: -122.103, type: "AcuteCare", affiliation: "MultiCare", telestrokePartner: "MultiCare", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "EvergreenHealth Medical Center", city: "Kirkland, WA", lat: 47.697, lon: -122.19, type: "AcuteCare", affiliation: "EvergreenHealth", telestrokePartner: "TBD", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Grays Harbor Community Hospital", city: "Aberdeen, WA", lat: 46.974, lon: -123.793, type: "AcuteCare", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "PeaceHealth Southwest Medical Center", city: "Vancouver, WA", lat: 45.65, lon: -122.656, type: "AcuteCare", affiliation: "PeaceHealth", telestrokePartner: "PeaceHealth", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "PeaceHealth St. John Medical Center", city: "Longview, WA", lat: 46.129, lon: -122.923, type: "AcuteCare", affiliation: "PeaceHealth", telestrokePartner: "PeaceHealth", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Providence St. Mary Medical Center", city: "Walla Walla, WA", lat: 46.073, lon: -118.324, type: "AcuteCare", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Swedish Ballard", city: "Seattle, WA", lat: 47.667, lon: -122.383, type: "AcuteCare", affiliation: "Swedish", telestrokePartner: "Swedish", stateStrokeLevel: "Level III", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Swedish First Hill", city: "Seattle, WA", lat: 47.611, lon: -122.32, type: "AcuteCare", affiliation: "Swedish", telestrokePartner: "Swedish", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Yakima Valley Memorial Hospital", city: "Yakima, WA", lat: 46.594, lon: -120.53, type: "AcuteCare", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "CHI Franciscan Rehabilitation Hospital", city: "Tacoma, WA", lat: 47.21, lon: -122.464, type: "AcuteCare", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            // N-ID
            { name: "Kootenai Health", city: "Coeur d'Alene, ID", lat: 47.697, lon: -116.804, type: "AcuteCare", affiliation: "Kootenai Health", telestrokePartner: "Kootenai Health", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Joseph Regional Medical Center", city: "Lewiston, ID", lat: 46.401, lon: -117.021, type: "AcuteCare", affiliation: "ScionHealth", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" }
        ];

        // 7 Primary Stroke Centers (PSC)
        const pscData = [
            { name: "Confluence Health Hospital | Central Campus", city: "Wenatchee, WA", lat: 47.419, lon: -120.323, type: "PSC", affiliation: "Confluence Health", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Gritman Medical Center", city: "Moscow, ID", lat: 46.732, lon: -117.001, type: "PSC", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Kittitas Valley Healthcare", city: "Ellensburg, WA", lat: 46.992, lon: -120.536, type: "PSC", affiliation: "Independent", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Olympic Medical Center", city: "Port Angeles, WA", lat: 48.11, lon: -123.456, type: "PSC", affiliation: "Independent", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Providence St. Mary Medical Center", city: "Walla Walla, WA", lat: 46.073, lon: -118.324, type: "PSC", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Joseph Regional Medical Center", city: "Lewiston, ID", lat: 46.401, lon: -117.021, type: "PSC", affiliation: "ScionHealth", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Tri-State Memorial Hospital", city: "Clarkston, WA", lat: 46.401, lon: -117.065, type: "PSC", affiliation: "Independent", telestrokePartner: "TBD", stateStrokeLevel: "Level II", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" }
        ];

        // 17 Comprehensive Stroke Centers (CSC)
        const cscData = [
            { name: "Harborview Medical Center (UW)", city: "Seattle, WA", lat: 47.604, lon: -122.325, type: "CSC", affiliation: "UW Medicine", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "EvergreenHealth Medical Center", city: "Kirkland, WA", lat: 47.697, lon: -122.19, type: "CSC", affiliation: "EvergreenHealth", telestrokePartner: "TBD", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Kadlec Regional Medical Center", city: "Richland, WA", lat: 46.29, lon: -119.288, type: "CSC", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Kootenai Health", city: "Coeur d'Alene, ID", lat: 47.697, lon: -116.804, type: "CSC", affiliation: "Kootenai Health", telestrokePartner: "Kootenai Health", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "MultiCare Deaconess Hospital", city: "Spokane, WA", lat: 47.653, lon: -117.43, type: "CSC", affiliation: "MultiCare", telestrokePartner: "MultiCare", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "MultiCare Tacoma General Hospital", city: "Tacoma, WA", lat: 47.251, lon: -122.454, type: "CSC", affiliation: "MultiCare", telestrokePartner: "MultiCare", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Overlake Medical Center", city: "Bellevue, WA", lat: 47.616, lon: -122.18, type: "CSC", affiliation: "Overlake", telestrokePartner: "TBD", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "PeaceHealth Sacred Heart Medical Center", city: "Springfield, OR", lat: 44.06, lon: -123.023, type: "CSC", affiliation: "PeaceHealth", telestrokePartner: "PeaceHealth", stateStrokeLevel: "TBD", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "PeaceHealth Southwest Medical Center", city: "Vancouver, WA", lat: 45.65, lon: -122.656, type: "CSC", affiliation: "PeaceHealth", telestrokePartner: "PeaceHealth", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "PeaceHealth St. Joseph Medical Center", city: "Bellingham, WA", lat: 48.77, lon: -122.464, type: "CSC", affiliation: "PeaceHealth", telestrokePartner: "PeaceHealth", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Providence Holy Family Hospital", city: "Spokane, WA", lat: 47.707, lon: -117.423, type: "CSC", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Providence Regional Medical Center Everett", city: "Everett, WA", lat: 47.962, lon: -122.20, type: "CSC", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Providence St. Peter Hospital", city: "Olympia, WA", lat: 47.017, lon: -122.883, type: "CSC", affiliation: "Providence", telestrokePartner: "Providence", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "St. Joseph Medical Center", city: "Tacoma, WA", lat: 47.242, lon: -122.441, type: "CSC", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Swedish First Hill", city: "Seattle, WA", lat: 47.611, lon: -122.32, type: "CSC", affiliation: "Swedish", telestrokePartner: "Swedish", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "UW Medical Center - Montlake", city: "Seattle, WA", lat: 47.649, lon: -122.308, type: "CSC", affiliation: "UW Medicine", telestrokePartner: "UW Medicine", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" },
            { name: "Yakima Valley Memorial Hospital", city: "Yakima, WA", lat: 46.594, lon: -120.53, type: "CSC", affiliation: "Virginia Mason Franciscan", telestrokePartner: "TBD", stateStrokeLevel: "Level I (CSC)", annualEDVolume: "TBD", hasHelipad: "TBD", hasCT_24_7: "TBD" }
        ];

        // --- 2. MAP INITIALIZATION ---

        let map;
        let cahLayer, acuteCareLayer, pscLayer, cscLayer;
        const allMapLayers = []; // To hold all markers for filtering

        document.addEventListener('DOMContentLoaded', initMap);

        function initMap() {
            map = L.map('map').setView([47.5, -120.5], 6);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            createLayers();
            initFilters();
        }

        // --- 3. LAYER & MARKER CREATION ---

        function createLayers() {
            cahLayer = L.layerGroup();
            acuteCareLayer = L.layerGroup();
            pscLayer = L.layerGroup();
            cscLayer = L.layerGroup();

            const icons = {
                cah: L.AwesomeMarkers.icon({ icon: 'fa-circle', markerColor: 'blue', prefix: 'fa', iconSize: [20, 30] }),
                acute: L.AwesomeMarkers.icon({ icon: 'fa-map-pin', markerColor: 'gray', prefix: 'fa', iconSize: [20, 30] }),
                psc: L.AwesomeMarkers.icon({ icon: 'fa-star', markerColor: 'darkred', prefix: 'fa', iconSize: [20, 30] }),
                csc: L.AwesomeMarkers.icon({ icon: 'fa-star', markerColor: 'purple', prefix: 'fa', iconSize: [20, 30] })
            };

            hospitalData.forEach(h => createMarker(h, icons.cah, cahLayer));
            acuteCareData.forEach(h => createMarker(h, icons.acute, acuteCareLayer));
            pscData.forEach(h => createMarker(h, icons.psc, pscLayer));
            cscData.forEach(h => createMarker(h, icons.csc, cscLayer));

            map.addLayer(cahLayer);
            map.addLayer(acuteCareLayer);
            map.addLayer(pscLayer);
            map.addLayer(cscLayer);

            // Open all permanent tooltips
            cahLayer.eachLayer(layer => layer.openTooltip());
            acuteCareLayer.eachLayer(layer => layer.openTooltip());
            pscLayer.eachLayer(layer => layer.openTooltip());
            cscLayer.eachLayer(layer => layer.openTooltip());
        }

        function createMarker(hospital, icon, layer) {
            const marker = L.marker([hospital.lat, hospital.lon], { icon: icon });
            marker.bindPopup(formatPopup(hospital));

            // Add permanent label with hospital name
            const tooltip = L.tooltip({
                permanent: true,
                direction: 'right',
                className: 'hospital-label',
                offset: [10, 0],
                opacity: 1
            }).setContent(hospital.name);

            marker.bindTooltip(tooltip);

            marker.hospitalData = hospital; // Attach data to marker
            layer.addLayer(marker);

            // Add to filterable list only if it's a CAH or AcuteCare
            if (hospital.type === 'CAH' || hospital.type === 'AcuteCare') {
                 allMapLayers.push(marker);
            }
        }

        // --- 4. POPUP & DISTANCE LOGIC ---

        function formatPopup(hospital) {
            const distance = calculateDistance(harborviewCoords.lat, harborviewCoords.lon, hospital.lat, hospital.lon);

            const tbd = (val) => val === "TBD" ? `<span class="popup-tbd">${val}</span>` : val;

            let competitorPartner = "";
            if (hospital.telestrokePartner !== "UW Medicine" && hospital.telestrokePartner !== "TBD") {
                competitorPartner = `(Competitor: ${hospital.telestrokePartner})`;
            }

            return `
                <div class="p-1">
                    <h4 class="font-bold text-base mb-1">${hospital.name}</h4>
                    <p class="text-sm">${hospital.city}</p>
                    <hr class="my-2">
                    <p class="text-sm"><strong>Distance to HMC:</strong> ${distance.toFixed(0)} miles</p>
                    <p class="text-sm"><strong>Telestroke:</strong> ${tbd(hospital.telestrokePartner)}</p>
                    <p class="text-sm"><strong>Affiliation:</strong> ${tbd(hospital.affiliation)}</p>
                    <p class="text-sm"><strong>State Stroke Level:</strong> ${tbd(hospital.stateStrokeLevel)}</p>
                    <p class="text-sm"><strong>24/7 CT:</strong> ${tbd(hospital.hasCT_24_7)}</p>
                    <p class="text-sm"><strong>Helipad:</strong> ${tbd(hospital.hasHelipad)}</p>
                    <p class="text-sm"><strong>Annual ED Volume:</strong> ${tbd(hospital.annualEDVolume)}</p>
                </div>
            `;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Radius of the Earth in miles
            const rlat1 = lat1 * (Math.PI / 180);
            const rlat2 = lat2 * (Math.PI / 180);
            const diffLat = (lat2 - lat1) * (Math.PI / 180);
            const diffLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(diffLat / 2) * Math.sin(diffLat / 2) +
                Math.cos(rlat1) * Math.cos(rlat2) *
                Math.sin(diffLon / 2) * Math.sin(diffLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- 5. FILTER LOGIC ---

        function initFilters() {
            // Layer Toggles
            document.getElementById('cah-toggle').addEventListener('change', (e) => toggleLayer(e.target.checked, cahLayer));
            document.getElementById('acute-toggle').addEventListener('change', (e) => toggleLayer(e.target.checked, acuteCareLayer));
            document.getElementById('psc-toggle').addEventListener('change', (e) => toggleLayer(e.target.checked, pscLayer));
            document.getElementById('csc-toggle').addEventListener('change', (e) => toggleLayer(e.target.checked, cscLayer));

            // Data Filters
            document.getElementById('affiliation-filter').addEventListener('change', updateMapFilters);
            document.getElementById('helipad-filter').addEventListener('change', updateMapFilters);
            document.getElementById('ct-filter').addEventListener('change', updateMapFilters);
        }

        function toggleLayer(checked, layer) {
            if (checked) {
                map.addLayer(layer);
            } else {
                map.removeLayer(layer);
            }
        }

        function updateMapFilters() {
            const affiliation = document.getElementById('affiliation-filter').value;
            const hasHelipad = document.getElementById('helipad-filter').checked;
            const hasCT = document.getElementById('ct-filter').checked;

            allMapLayers.forEach(marker => {
                let show = true;
                const data = marker.hospitalData;

                // Affiliation Filter
                if (affiliation === 'TBD' && data.telestrokePartner !== 'TBD') {
                    show = false;
                } else if (affiliation === 'UW Medicine' && data.telestrokePartner !== 'UW Medicine') {
                    show = false;
                } else if (affiliation === 'Competitor' && (data.telestrokePartner === 'TBD' || data.telestrokePartner === 'UW Medicine')) {
                    show = false;
                }

                // Capability Filters (only filter if checked)
                if (hasHelipad && data.hasHelipad !== 'Yes') {
                    // Note: This will hide "TBD"s. This is the desired logic.
                    show = false;
                }
                if (hasCT && data.hasCT_24_7 !== 'Yes') {
                    // Note: This will hide "TBD"s.
                    show = false;
                }

                // Show or hide the marker
                marker.setOpacity(show ? 1.0 : 0.2);

                // Make filtered-out markers unclickable
                if (show) {
                    marker.setZIndexOffset(100); // Bring to front
                } else {
                    marker.setZIndexOffset(0); // Send to back
                }
            });
        }

    </script>
</body>
</html>
