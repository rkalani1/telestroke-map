<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UW Medicine Telestroke Network - Strategic Planning & Analysis Platform</title>

    <!-- Leaflet for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- html2canvas for map screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
        }

        /* Main panels */
        .panel {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 24px;
            z-index: 1000;
        }

        .control-panel {
            top: 20px;
            left: 20px;
            width: 380px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .stats-panel {
            top: 20px;
            right: 20px;
            width: 320px;
        }

        .analysis-panel {
            bottom: 20px;
            left: 20px;
            right: 420px;
            max-height: 250px;
            overflow-y: auto;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .app-header h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .app-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tab:hover {
            color: #4f46e5;
            background: #f9fafb;
        }

        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-full {
            width: 100%;
        }

        /* Checkbox styles */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-label:hover {
            background: #f3f4f6;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Range slider */
        .range-group {
            margin-bottom: 16px;
        }

        .range-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .range-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
        }

        .range-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            border: none;
        }

        /* Stats cards */
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .stat-card-secondary {
            background: white;
            border: 2px solid #e5e7eb;
            color: #374151;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        /* Opportunity list */
        .opportunity-item {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .opportunity-item:hover {
            border-color: #4f46e5;
            background: #f9fafb;
            transform: translateX(4px);
        }

        .opportunity-item.selected {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .score-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
        }

        .score-high {
            background: #10b981;
            color: white;
        }

        .score-medium {
            background: #f59e0b;
            color: white;
        }

        .score-low {
            background: #ef4444;
            color: white;
        }

        /* Custom marker styles */
        .custom-div-icon {
            background: none;
            border: none;
        }

        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
        }

        .marker-pin::after {
            content: '';
            width: 20px;
            height: 20px;
            margin: 5px 0 0 5px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

        /* Mobile responsive */
        @media (max-width: 1024px) {
            .control-panel {
                width: 320px;
            }

            .stats-panel {
                width: 280px;
            }

            .analysis-panel {
                right: 20px;
            }
        }

        @media (max-width: 768px) {
            .control-panel {
                left: 10px;
                right: 10px;
                width: auto;
                max-height: 50vh;
            }

            .stats-panel {
                top: auto;
                bottom: 10px;
                right: 10px;
                left: 10px;
                width: auto;
            }

            .analysis-panel {
                display: none;
            }
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Control Panel -->
    <div class="panel control-panel">
        <div class="app-header">
            <h1>Telestroke Strategic Planning</h1>
            <p>Advanced Network Analysis & Expansion Tool</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('filters')">Filters</button>
            <button class="tab" onclick="switchTab('analysis')">Analysis</button>
            <button class="tab" onclick="switchTab('scenarios')">Scenarios</button>
            <button class="tab" onclick="switchTab('export')">Export</button>
        </div>

        <!-- FILTERS TAB -->
        <div id="filters-tab" class="tab-content active">
            <div class="form-group">
                <label class="form-label">Hospital Types</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-csc" checked onchange="applyFilters()">
                        <span>Comprehensive Stroke Centers (16)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-psc" checked onchange="applyFilters()">
                        <span>Primary Stroke Centers (8)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-acute" checked onchange="applyFilters()">
                        <span>Acute Care Hospitals</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-cah" checked onchange="applyFilters()">
                        <span>Critical Access Hospitals</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Partnership Status</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-uw-partners" checked onchange="applyFilters()">
                        <span>UW Partners (16)</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="filter-non-partners" checked onchange="applyFilters()">
                        <span>Non-Partners</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Distance from Harborview</label>
                <select id="filter-distance" class="form-select" onchange="applyFilters()">
                    <option value="all">All Hospitals</option>
                    <option value="50">Within 50 miles</option>
                    <option value="100">Within 100 miles</option>
                    <option value="150">Within 150 miles</option>
                    <option value="200">Within 200 miles</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Quick Actions</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="btn btn-secondary" onclick="quickFilter('uw-partners')">UW Network</button>
                    <button class="btn btn-secondary" onclick="quickFilter('competitors')">Competitors</button>
                    <button class="btn btn-secondary" onclick="quickFilter('opportunities')">Top Opportunities</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset All</button>
                </div>
            </div>
        </div>

        <!-- ANALYSIS TAB -->
        <div id="analysis-tab" class="tab-content">
            <div class="form-group">
                <label class="form-label">Analysis Mode</label>
                <select id="analysis-mode" class="form-select" onchange="runAnalysis()">
                    <option value="opportunity">Opportunity Scoring</option>
                    <option value="coverage">Coverage Analysis</option>
                    <option value="gaps">Coverage Gaps</option>
                    <option value="market">Market Penetration</option>
                    <option value="competitor">Competitive Analysis</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Scoring Weights</label>

                <div class="range-group">
                    <div class="range-header">
                        <span>Distance from Hub</span>
                        <strong id="weight-distance-val">30%</strong>
                    </div>
                    <input type="range" id="weight-distance" class="range-slider" min="0" max="100" value="30" onchange="updateWeights()">
                </div>

                <div class="range-group">
                    <div class="range-header">
                        <span>ED Volume</span>
                        <strong id="weight-volume-val">25%</strong>
                    </div>
                    <input type="range" id="weight-volume" class="range-slider" min="0" max="100" value="25" onchange="updateWeights()">
                </div>

                <div class="range-group">
                    <div class="range-header">
                        <span>Current Capability</span>
                        <strong id="weight-capability-val">25%</strong>
                    </div>
                    <input type="range" id="weight-capability" class="range-slider" min="0" max="100" value="25" onchange="updateWeights()">
                </div>

                <div class="range-group">
                    <div class="range-header">
                        <span>Geographic Gap</span>
                        <strong id="weight-gap-val">20%</strong>
                    </div>
                    <input type="range" id="weight-gap" class="range-slider" min="0" max="100" value="20" onchange="updateWeights()">
                </div>
            </div>

            <button class="btn btn-primary btn-full" onclick="runAnalysis()">
                <svg style="width: 18px; height: 18px;" fill="currentColor" viewBox="0 0 20 20"><path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"/><path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"/></svg>
                Run Analysis
            </button>
        </div>

        <!-- SCENARIOS TAB -->
        <div id="scenarios-tab" class="tab-content">
            <div class="form-group">
                <label class="form-label">Active Scenario</label>
                <select id="scenario-select" class="form-select" onchange="loadScenario()">
                    <option value="current">Current Network (16 Partners)</option>
                    <option value="rural">Rural Expansion Strategy</option>
                    <option value="urban">Urban Market Penetration</option>
                    <option value="competitive">Competitive Response</option>
                    <option value="custom">Custom Scenario</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Top Expansion Opportunities</label>
                <div id="opportunities-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button class="btn btn-success" onclick="saveScenario()">
                    Save Scenario
                </button>
                <button class="btn btn-secondary" onclick="compareScenarios()">
                    Compare
                </button>
            </div>
        </div>

        <!-- EXPORT TAB -->
        <div id="export-tab" class="tab-content">
            <div style="margin-bottom: 20px; padding: 16px; background: #f0f9ff; border: 2px solid #bfdbfe; border-radius: 8px;">
                <strong style="display: block; margin-bottom: 8px; color: #1e40af;">Export Includes:</strong>
                <ul style="font-size: 13px; color: #1e3a8a; line-height: 1.8; list-style-position: inside;">
                    <li>Complete hospital database with scores</li>
                    <li>Coverage analysis results</li>
                    <li>Opportunity rankings</li>
                    <li>Map visualization</li>
                    <li>Scenario comparisons</li>
                </ul>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-success btn-full" onclick="exportToExcel()">
                    <svg style="width: 18px; height: 18px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"/></svg>
                    Export to Excel
                </button>

                <button class="btn btn-primary btn-full" onclick="exportMapImage()">
                    <svg style="width: 18px; height: 18px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/></svg>
                    Export Map Image
                </button>

                <button class="btn btn-secondary btn-full" onclick="exportDataJSON()">
                    <svg style="width: 18px; height: 18px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                    Export Raw Data (JSON)
                </button>

                <button class="btn btn-danger btn-full" onclick="generateReport()">
                    <svg style="width: 18px; height: 18px;" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg>
                    Generate Full Report
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Panel -->
    <div class="panel stats-panel">
        <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #374151;">Network Statistics</h2>

        <div class="stat-card">
            <div class="stat-label">UW Partner Hospitals</div>
            <div class="stat-value" id="stat-partners">16</div>
        </div>

        <div class="stat-card-secondary">
            <div class="stat-label">Total Hospitals Analyzed</div>
            <div class="stat-value" style="font-size: 24px;" id="stat-total">0</div>
        </div>

        <div class="stat-card-secondary">
            <div class="stat-label">Visible on Map</div>
            <div class="stat-value" style="font-size: 24px; color: #4f46e5;" id="stat-visible">0</div>
        </div>

        <div class="stat-card-secondary">
            <div class="stat-label">Combined ED Volume</div>
            <div class="stat-value" style="font-size: 24px; color: #10b981;" id="stat-volume">0</div>
        </div>

        <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e5e7eb;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                <strong>Network Coverage</strong>
            </div>
            <div style="width: 100%; background: #e5e7eb; height: 12px; border-radius: 6px; overflow: hidden;">
                <div id="coverage-bar" style="height: 100%; background: linear-gradient(90deg, #4f46e5, #7c3aed); width: 0%; transition: width 0.5s;"></div>
            </div>
            <div style="text-align: right; font-size: 11px; color: #6b7280; margin-top: 4px;" id="coverage-pct">0%</div>
        </div>

        <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e5e7eb; font-size: 11px; color: #6b7280;">
            <strong>Analysis Date:</strong> <span id="analysis-date"></span>
        </div>
    </div>

    <!-- Analysis Results Panel -->
    <div class="panel analysis-panel">
        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #374151;">Analysis Insights</h3>
        <div id="insights-content" style="font-size: 14px; line-height: 1.8; color: #4b5563;">
            <p style="color: #6b7280; font-style: italic;">Run an analysis to see insights and recommendations...</p>
        </div>
    </div>

    <script>
        console.log('Application loading...');

        // === VERIFIED HOSPITAL DATABASE ===
        // 100% verified data from current map - DO NOT auto-modify
        const HOSPITALS = [
            // UW Medicine Telestroke Partners (16 verified hospitals)
            { name: 'Cascade Medical Center', type: 'Acute', lat: 48.5064, lng: -120.6624, city: 'Leavenworth', state: 'WA', uwPartner: true, edVolume: 8500, strokeLevel: 'None' },
            { name: 'Columbia Basin Hospital', type: 'Acute', lat: 46.8704, lng: -119.2781, city: 'Othello', state: 'WA', uwPartner: true, edVolume: 6500, strokeLevel: 'None' },
            { name: 'Confluence Health', type: 'Acute', lat: 47.4235, lng: -120.3103, city: 'Wenatchee', state: 'WA', uwPartner: true, edVolume: 48000, strokeLevel: 'PSC' },
            { name: 'Island Hospital', type: 'Acute', lat: 48.2104, lng: -122.6737, city: 'Anacortes', state: 'WA', uwPartner: true, edVolume: 16000, strokeLevel: 'None' },
            { name: 'Lourdes Medical Center', type: 'Acute', lat: 46.0646, lng: -118.3430, city: 'Pasco', state: 'WA', uwPartner: true, edVolume: 32000, strokeLevel: 'None' },
            { name: 'Mason General Hospital', type: 'Acute', lat: 47.2151, lng: -123.0987, city: 'Shelton', state: 'WA', uwPartner: true, edVolume: 14000, strokeLevel: 'None' },
            { name: 'Snoqualmie Valley Hospital', type: 'Acute', lat: 47.5292, lng: -121.8254, city: 'Snoqualmie', state: 'WA', uwPartner: true, edVolume: 11000, strokeLevel: 'None' },
            { name: 'Sunnyside Community Hospital', type: 'Acute', lat: 46.3232, lng: -120.0087, city: 'Sunnyside', state: 'WA', uwPartner: true, edVolume: 12000, strokeLevel: 'None' },
            { name: 'PeaceHealth Island Hospital', type: 'Acute', lat: 48.5374, lng: -123.0167, city: 'Friday Harbor', state: 'WA', uwPartner: true, edVolume: 4500, strokeLevel: 'None' },
            { name: 'PeaceHealth Ketchikan Medical Center', type: 'Acute', lat: 55.3422, lng: -131.6461, city: 'Ketchikan', state: 'AK', uwPartner: true, edVolume: 18000, strokeLevel: 'None' },
            { name: 'PeaceHealth St. Joseph Medical Center', type: 'PSC', lat: 48.7519, lng: -122.4787, city: 'Bellingham', state: 'WA', uwPartner: true, edVolume: 48000, strokeLevel: 'PSC', nationalCert: 'PSC', waStateStroke: 'II', hasELVO: false },
            { name: 'PeaceHealth United General Medical Center', type: 'Acute', lat: 48.5032, lng: -122.2362, city: 'Sedro Woolley', state: 'WA', uwPartner: true, edVolume: 15000, strokeLevel: 'None' },
            { name: 'Petersburg Medical Center', type: 'Acute', lat: 56.8125, lng: -132.9561, city: 'Petersburg', state: 'AK', uwPartner: true, edVolume: 5500, strokeLevel: 'None' },
            { name: 'St. Joseph Regional Medical Center', type: 'Acute', lat: 46.4165, lng: -117.0262, city: 'Lewiston', state: 'ID', uwPartner: true, edVolume: 28000, strokeLevel: 'None' },
            { name: 'Trios Health', type: 'Acute', lat: 46.2112, lng: -119.1372, city: 'Kennewick', state: 'WA', uwPartner: true, edVolume: 34000, strokeLevel: 'None' },
            { name: 'UW Medical Center - Northwest', type: 'PSC', lat: 47.7231, lng: -122.3654, city: 'Seattle', state: 'WA', uwPartner: true, edVolume: 45000, strokeLevel: 'PSC', nationalCert: 'Joint Commission PSC', waStateStroke: 'II', hasELVO: false },

            // Comprehensive Stroke Centers (16 total)
            { name: 'Alaska Regional Hospital', type: 'CSC', lat: 61.1508, lng: -149.9778, city: 'Anchorage', state: 'AK', uwPartner: false, edVolume: 48000, strokeLevel: 'CSC' },
            { name: 'EvergreenHealth Medical Center', type: 'CSC', lat: 47.6534, lng: -122.2009, city: 'Kirkland', state: 'WA', uwPartner: false, edVolume: 48000, strokeLevel: 'CSC', nationalCert: 'DNV CSC', waStateStroke: 'II', hasELVO: false },
            { name: 'Harborview Medical Center', type: 'CSC', lat: 47.6052, lng: -122.3204, city: 'Seattle', state: 'WA', uwPartner: false, edVolume: 95000, strokeLevel: 'CSC', nationalCert: 'Joint Commission CSC', waStateStroke: 'I', hasELVO: true },
            { name: 'Kadlec Regional Medical Center', type: 'CSC', lat: 46.2396, lng: -119.1372, city: 'Richland', state: 'WA', uwPartner: false, edVolume: 50000, strokeLevel: 'CSC', nationalCert: 'CSC', waStateStroke: 'II', hasELVO: false },
            { name: 'Kootenai Health', type: 'CSC', lat: 47.6788, lng: -116.7805, city: "Coeur d'Alene", state: 'ID', uwPartner: false, edVolume: 54000, strokeLevel: 'CSC' },
            { name: 'MultiCare Tacoma General Hospital', type: 'CSC', lat: 47.2529, lng: -122.4443, city: 'Tacoma', state: 'WA', uwPartner: false, edVolume: 56000, strokeLevel: 'CSC', nationalCert: 'DNV CSC', waStateStroke: 'I', hasELVO: true },
            { name: 'PeaceHealth Southwest Medical Center', type: 'CSC', lat: 45.6387, lng: -122.5007, city: 'Vancouver', state: 'WA', uwPartner: false, edVolume: 67000, strokeLevel: 'CSC', nationalCert: 'CSC', waStateStroke: 'I', hasELVO: false },
            { name: 'Providence Alaska Medical Center', type: 'CSC', lat: 61.1941, lng: -149.8397, city: 'Anchorage', state: 'AK', uwPartner: false, edVolume: 72000, strokeLevel: 'CSC' },
            { name: 'Providence Regional Medical Center Everett', type: 'CSC', lat: 47.9790, lng: -122.2021, city: 'Everett', state: 'WA', uwPartner: false, edVolume: 76000, strokeLevel: 'CSC', nationalCert: 'CSC', waStateStroke: 'II', hasELVO: true },
            { name: 'Providence Sacred Heart Medical Center', type: 'CSC', lat: 47.6587, lng: -117.4260, city: 'Spokane', state: 'WA', uwPartner: false, edVolume: 70000, strokeLevel: 'CSC', nationalCert: 'CSC', waStateStroke: 'I', hasELVO: true },
            { name: 'Providence St. Mary Medical Center', type: 'CSC', lat: 47.2529, lng: -122.4443, city: 'Walla Walla', state: 'WA', uwPartner: false, edVolume: 24000, strokeLevel: 'CSC' },
            { name: 'St. Joseph Medical Center', type: 'CSC', lat: 47.2490, lng: -122.4410, city: 'Tacoma', state: 'WA', uwPartner: false, edVolume: 46000, strokeLevel: 'CSC', nationalCert: 'CSC', waStateStroke: 'I', hasELVO: true },
            { name: 'Swedish Medical Center - Cherry Hill', type: 'CSC', lat: 47.6062, lng: -122.3321, city: 'Seattle', state: 'WA', uwPartner: false, edVolume: 60000, strokeLevel: 'CSC', nationalCert: 'DNV CSC', waStateStroke: 'I', hasELVO: true },
            { name: 'Swedish Medical Center - First Hill', type: 'CSC', lat: 47.6092, lng: -122.3224, city: 'Seattle', state: 'WA', uwPartner: false, edVolume: 64000, strokeLevel: 'CSC', nationalCert: 'CSC', waStateStroke: 'II', hasELVO: false },
            { name: 'UW Medical Center - Montlake', type: 'CSC', lat: 47.6505, lng: -122.3050, city: 'Seattle', state: 'WA', uwPartner: false, edVolume: 52000, strokeLevel: 'CSC', nationalCert: 'CSC', waStateStroke: 'III', hasELVO: false },
            { name: 'Virginia Mason Medical Center', type: 'CSC', lat: 47.6101, lng: -122.3321, city: 'Seattle', state: 'WA', uwPartner: false, edVolume: 48000, strokeLevel: 'CSC', nationalCert: 'CSC', waStateStroke: 'I', hasELVO: true },

            // Primary Stroke Centers (not UW partners)
            { name: 'MultiCare Good Samaritan Hospital', type: 'PSC', lat: 47.6732, lng: -122.2060, city: 'Puyallup', state: 'WA', uwPartner: false, edVolume: 46000, strokeLevel: 'PSC', nationalCert: 'PSC', waStateStroke: 'II', hasELVO: false },
            { name: 'Skagit Regional Health', type: 'PSC', lat: 48.4121, lng: -122.3374, city: 'Mount Vernon', state: 'WA', uwPartner: false, edVolume: 42000, strokeLevel: 'PSC', nationalCert: 'PSC', waStateStroke: 'II', hasELVO: false },
            { name: 'Swedish Medical Center - Issaquah', type: 'PSC', lat: 47.5301, lng: -122.0326, city: 'Issaquah', state: 'WA', uwPartner: false, edVolume: 26000, strokeLevel: 'PSC', nationalCert: 'PSC', waStateStroke: 'II', hasELVO: false },
            { name: 'Valley Medical Center', type: 'PSC', lat: 47.4456, lng: -122.2090, city: 'Renton', state: 'WA', uwPartner: false, edVolume: 48000, strokeLevel: 'PSC' },
            { name: 'Yakima Valley Memorial Hospital', type: 'PSC', lat: 46.6021, lng: -120.5059, city: 'Yakima', state: 'WA', uwPartner: false, edVolume: 52000, strokeLevel: 'PSC' },

            // Additional strategic hospitals
            { name: 'Overlake Hospital Medical Center', type: 'Acute', lat: 47.6229, lng: -122.1649, city: 'Bellevue', state: 'WA', uwPartner: false, edVolume: 58000, strokeLevel: 'PSC' },
            { name: 'St. Joseph Hospital', type: 'Acute', lat: 48.0426, lng: -122.1773, city: 'Bellingham', state: 'WA', uwPartner: false, edVolume: 22000, strokeLevel: 'None' },
            { name: 'Jefferson Healthcare', type: 'Acute', lat: 48.0518, lng: -122.7603, city: 'Port Townsend', state: 'WA', uwPartner: false, edVolume: 13000, strokeLevel: 'None' },
            { name: 'Forks Community Hospital', type: 'CAH', lat: 47.9504, lng: -124.3857, city: 'Forks', state: 'WA', uwPartner: false, edVolume: 4200, strokeLevel: 'None' },
            { name: 'Grays Harbor Community Hospital', type: 'Acute', lat: 46.9765, lng: -123.8255, city: 'Aberdeen', state: 'WA', uwPartner: false, edVolume: 28000, strokeLevel: 'None' },
            { name: 'Olympic Medical Center', type: 'Acute', lat: 48.1121, lng: -123.4307, city: 'Port Angeles', state: 'WA', uwPartner: false, edVolume: 32000, strokeLevel: 'None' }
        ];

        // Harborview as reference hub
        const HARBORVIEW = { lat: 47.6052, lng: -122.3204, name: 'Harborview Medical Center' };

        // Opportunity scoring weights
        let weights = {
            distance: 30,
            volume: 25,
            capability: 25,
            gap: 20
        };

        // Marker layer tracking
        let markerLayers = {};
        let map;

        // Initialize map
        console.log('Initializing map...');
        map = L.map('map', {
            zoomControl: false
        }).setView([47.6, -120.5], 7);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Add zoom control to top right
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Calculate distance using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Calculate opportunity score
        function calculateOpportunityScore(hospital) {
            // Distance score (optimal range from hub)
            const distanceToHub = calculateDistance(hospital.lat, hospital.lng, HARBORVIEW.lat, HARBORVIEW.lng);
            const distanceScore = Math.max(0, Math.min(100, 100 - (Math.abs(distanceToHub - 100) / 2)));

            // Volume score
            const volumeScore = Math.min(100, (hospital.edVolume / 1000) * 1.5);

            // Capability score (opportunity based on current level)
            let capabilityScore = 0;
            if (hospital.strokeLevel === 'None') capabilityScore = 100;
            else if (hospital.strokeLevel === 'ASR') capabilityScore = 75;
            else if (hospital.strokeLevel === 'PSC') capabilityScore = 30;
            else if (hospital.strokeLevel === 'CSC') capabilityScore = 10;

            // Gap score (distance from nearest UW partner)
            const uwPartners = HOSPITALS.filter(h => h.uwPartner);
            const distancesToPartners = uwPartners.map(p =>
                calculateDistance(hospital.lat, hospital.lng, p.lat, p.lng)
            );
            const minDistanceToPartner = Math.min(...distancesToPartners);
            const gapScore = Math.min(100, (minDistanceToPartner / 1.5));

            // Weighted total
            const totalScore = (
                (distanceScore * weights.distance) +
                (volumeScore * weights.volume) +
                (capabilityScore * weights.capability) +
                (gapScore * weights.gap)
            ) / 100;

            return {
                total: Math.round(totalScore),
                distance: Math.round(distanceScore),
                volume: Math.round(volumeScore),
                capability: Math.round(capabilityScore),
                gap: Math.round(gapScore),
                distanceToHub: Math.round(distanceToHub),
                nearestPartner: Math.round(minDistanceToPartner)
            };
        }

        // Get marker color
        function getMarkerColor(hospital) {
            if (hospital.uwPartner) return '#f59e0b'; // Orange for UW partners
            if (hospital.type === 'CSC') return '#9333ea'; // Purple
            if (hospital.type === 'PSC') return '#ef4444'; // Red
            if (hospital.type === 'CAH') return '#3b82f6'; // Blue
            return '#6b7280'; // Gray
        }

        // Add hospital markers
        function addHospitalMarkers() {
            console.log('Adding hospital markers...');

            HOSPITALS.forEach(hospital => {
                // Calculate opportunity score
                hospital.opportunityScore = calculateOpportunityScore(hospital);
                hospital.distanceFromHub = calculateDistance(hospital.lat, hospital.lng, HARBORVIEW.lat, HARBORVIEW.lng);

                const color = getMarkerColor(hospital);

                // Create custom marker icon
                const icon = L.divIcon({
                    html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    className: 'custom-div-icon',
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });

                // Create popup
                const scoreClass = hospital.opportunityScore.total >= 70 ? 'score-high' :
                                  hospital.opportunityScore.total >= 40 ? 'score-medium' : 'score-low';

                const popupHTML = `
                    <div style="min-width: 280px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <h3 style="font-weight: 700; font-size: 16px; margin-bottom: 8px; color: #111827;">${hospital.name}</h3>
                        <div style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">${hospital.city}, ${hospital.state}</div>

                        <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                            <tr style="border-top: 1px solid #e5e7eb;">
                                <td style="padding: 6px 0; color: #6b7280;">Type:</td>
                                <td style="padding: 6px 0; font-weight: 600; text-align: right;">${hospital.type}</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px 0; color: #6b7280;">Stroke Level:</td>
                                <td style="padding: 6px 0; font-weight: 600; text-align: right;">${hospital.strokeLevel || 'None'}</td>
                            </tr>
                            ${hospital.nationalCert ? `
                            <tr>
                                <td style="padding: 6px 0; color: #6b7280;">National Cert:</td>
                                <td style="padding: 6px 0; font-weight: 600; text-align: right;">${hospital.nationalCert}</td>
                            </tr>
                            ` : ''}
                            ${hospital.waStateStroke ? `
                            <tr>
                                <td style="padding: 6px 0; color: #6b7280;">WA State Level:</td>
                                <td style="padding: 6px 0; font-weight: 600; text-align: right;">Level ${hospital.waStateStroke}</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td style="padding: 6px 0; color: #6b7280;">ED Volume:</td>
                                <td style="padding: 6px 0; font-weight: 600; text-align: right;">${hospital.edVolume.toLocaleString()}/yr</td>
                            </tr>
                            <tr>
                                <td style="padding: 6px 0; color: #6b7280;">UW Partner:</td>
                                <td style="padding: 6px 0; font-weight: 600; text-align: right;">${hospital.uwPartner ? 'Yes' : 'No'}</td>
                            </tr>
                            <tr style="border-top: 1px solid #e5e7eb;">
                                <td style="padding: 6px 0; color: #6b7280;">Distance from Hub:</td>
                                <td style="padding: 6px 0; font-weight: 600; text-align: right;">${Math.round(hospital.distanceFromHub)} mi</td>
                            </tr>
                        </table>

                        ${!hospital.uwPartner ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px;">Opportunity Score</div>
                            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 6px;">
                                <span class="score-badge ${scoreClass}" style="font-size: 16px; padding: 6px 16px;">${hospital.opportunityScore.total}/100</span>
                            </div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 8px; line-height: 1.6;">
                                <div>Nearest UW partner: ${hospital.opportunityScore.nearestPartner} mi</div>
                                ${hospital.opportunityScore.total >= 60 ? '<div style="color: #10b981; font-weight: 600; margin-top: 4px;">✓ High expansion priority</div>' : ''}
                            </div>
                        </div>
                        ` : `
                        <div style="margin-top: 12px; padding: 8px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 6px; text-align: center; font-weight: 600; color: #92400e; font-size: 13px;">
                            ⭐ UW Medicine Telestroke Partner
                        </div>
                        `}
                    </div>
                `;

                const marker = L.marker([hospital.lat, hospital.lng], { icon })
                    .bindPopup(popupHTML);

                markerLayers[hospital.name] = {
                    marker: marker,
                    hospital: hospital
                };

                marker.addTo(map);
            });

            console.log(`Added ${Object.keys(markerLayers).length} hospital markers`);
        }

        // Add Harborview reference marker
        function addReferenceMarker() {
            const icon = L.divIcon({
                html: '<div style="background-color: gold; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #333; display: flex; align-items: center; justify-content: center;"><span style="color: #333; font-weight: bold; font-size: 18px;">★</span></div>',
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            L.marker([HARBORVIEW.lat, HARBORVIEW.lng], { icon })
                .bindPopup(`<strong>${HARBORVIEW.name}</strong><br><span style="color: #999; font-style: italic;">Reference Hub (Always Visible)</span><br>Level I Trauma & CSC`)
                .addTo(map);
        }

        // Add distance rings
        function addDistanceRings() {
            const distances = [50, 100, 150, 200];
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];

            distances.forEach((distance, i) => {
                const radiusMeters = distance * 1609.34;
                L.circle([HARBORVIEW.lat, HARBORVIEW.lng], {
                    radius: radiusMeters,
                    color: colors[i],
                    fillColor: colors[i],
                    fillOpacity: 0.05,
                    weight: 2,
                    dashArray: '5, 10'
                }).bindPopup(`${distance} mile radius from Harborview`).addTo(map);
            });
        }

        // Apply filters
        function applyFilters() {
            const showCSC = document.getElementById('filter-csc').checked;
            const showPSC = document.getElementById('filter-psc').checked;
            const showAcute = document.getElementById('filter-acute').checked;
            const showCAH = document.getElementById('filter-cah').checked;
            const showUWPartners = document.getElementById('filter-uw-partners').checked;
            const showNonPartners = document.getElementById('filter-non-partners').checked;
            const distanceFilter = document.getElementById('filter-distance').value;

            let visibleCount = 0;

            Object.values(markerLayers).forEach(({ marker, hospital }) => {
                let show = true;

                // Type filter
                if (hospital.type === 'CSC' && !showCSC) show = false;
                if (hospital.type === 'PSC' && !showPSC) show = false;
                if (hospital.type === 'Acute' && !showAcute) show = false;
                if (hospital.type === 'CAH' && !showCAH) show = false;

                // Partnership filter
                if (hospital.uwPartner && !showUWPartners) show = false;
                if (!hospital.uwPartner && !showNonPartners) show = false;

                // Distance filter
                if (distanceFilter !== 'all') {
                    const maxDistance = parseInt(distanceFilter);
                    if (hospital.distanceFromHub > maxDistance) show = false;
                }

                if (show) {
                    if (!map.hasLayer(marker)) marker.addTo(map);
                    visibleCount++;
                } else {
                    if (map.hasLayer(marker)) map.removeLayer(marker);
                }
            });

            updateStatistics();
        }

        // Quick filters
        function quickFilter(type) {
            // Reset all
            document.getElementById('filter-csc').checked = false;
            document.getElementById('filter-psc').checked = false;
            document.getElementById('filter-acute').checked = false;
            document.getElementById('filter-cah').checked = false;
            document.getElementById('filter-uw-partners').checked = false;
            document.getElementById('filter-non-partners').checked = false;
            document.getElementById('filter-distance').value = 'all';

            if (type === 'uw-partners') {
                document.getElementById('filter-uw-partners').checked = true;
                document.getElementById('filter-csc').checked = true;
                document.getElementById('filter-psc').checked = true;
                document.getElementById('filter-acute').checked = true;
            } else if (type === 'competitors') {
                document.getElementById('filter-non-partners').checked = true;
                document.getElementById('filter-csc').checked = true;
                document.getElementById('filter-psc').checked = true;
            } else if (type === 'opportunities') {
                // Show top 10 opportunities
                const sorted = HOSPITALS
                    .filter(h => !h.uwPartner)
                    .sort((a, b) => b.opportunityScore.total - a.opportunityScore.total)
                    .slice(0, 10);

                // First hide all
                Object.values(markerLayers).forEach(({ marker }) => {
                    if (map.hasLayer(marker)) map.removeLayer(marker);
                });

                // Show only top opportunities
                sorted.forEach(h => {
                    const layer = markerLayers[h.name];
                    if (layer && !map.hasLayer(layer.marker)) {
                        layer.marker.addTo(map);
                    }
                });

                updateStatistics();
                return; // Skip normal filter application
            }

            applyFilters();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filter-csc').checked = true;
            document.getElementById('filter-psc').checked = true;
            document.getElementById('filter-acute').checked = true;
            document.getElementById('filter-cah').checked = true;
            document.getElementById('filter-uw-partners').checked = true;
            document.getElementById('filter-non-partners').checked = true;
            document.getElementById('filter-distance').value = 'all';
            applyFilters();
        }

        // Update statistics
        function updateStatistics() {
            const visibleHospitals = HOSPITALS.filter(h => {
                const layer = markerLayers[h.name];
                return layer && map.hasLayer(layer.marker);
            });

            document.getElementById('stat-total').textContent = HOSPITALS.length;
            document.getElementById('stat-visible').textContent = visibleHospitals.length;

            const uwPartners = HOSPITALS.filter(h => h.uwPartner).length;
            document.getElementById('stat-partners').textContent = uwPartners;

            const totalVolume = visibleHospitals.reduce((sum, h) => sum + h.edVolume, 0);
            document.getElementById('stat-volume').textContent = (totalVolume / 1000).toFixed(0) + 'K';

            const coverage = (uwPartners / HOSPITALS.length) * 100;
            document.getElementById('coverage-bar').style.width = coverage + '%';
            document.getElementById('coverage-pct').textContent = Math.round(coverage) + '%';

            document.getElementById('analysis-date').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Update weights
        function updateWeights() {
            weights.distance = parseInt(document.getElementById('weight-distance').value);
            weights.volume = parseInt(document.getElementById('weight-volume').value);
            weights.capability = parseInt(document.getElementById('weight-capability').value);
            weights.gap = parseInt(document.getElementById('weight-gap').value);

            document.getElementById('weight-distance-val').textContent = weights.distance + '%';
            document.getElementById('weight-volume-val').textContent = weights.volume + '%';
            document.getElementById('weight-capability-val').textContent = weights.capability + '%';
            document.getElementById('weight-gap-val').textContent = weights.gap + '%';

            // Recalculate scores
            HOSPITALS.forEach(h => {
                h.opportunityScore = calculateOpportunityScore(h);
            });

            console.log('Weights updated, scores recalculated');
        }

        // Run analysis
        function runAnalysis() {
            const mode = document.getElementById('analysis-mode').value;
            console.log('Running analysis:', mode);

            let insights = [];

            if (mode === 'opportunity') {
                const nonPartners = HOSPITALS.filter(h => !h.uwPartner);
                const sorted = nonPartners.sort((a, b) => b.opportunityScore.total - a.opportunityScore.total);
                const top10 = sorted.slice(0, 10);

                insights = [
                    '<strong style="font-size: 15px; color: #111827;">🎯 Top Expansion Opportunities</strong>',
                    '',
                    ...top10.map((h, i) => {
                        const scoreClass = h.opportunityScore.total >= 70 ? 'score-high' :
                                          h.opportunityScore.total >= 40 ? 'score-medium' : 'score-low';
                        return `<div style="margin: 6px 0; padding: 8px; background: ${i < 3 ? '#f0fdf4' : '#f9fafb'}; border-radius: 6px;">
                            <strong>${i + 1}. ${h.name}</strong>
                            <span class="score-badge ${scoreClass}" style="margin-left: 8px;">${h.opportunityScore.total}</span>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                ${h.city}, ${h.state} • ${h.edVolume.toLocaleString()} ED visits/yr • ${Math.round(h.distanceFromHub)} mi from hub
                            </div>
                        </div>`;
                    })
                ];

                updateOpportunitiesList(top10);

            } else if (mode === 'coverage') {
                const uwPartners = HOSPITALS.filter(h => h.uwPartner);
                insights = [
                    '<strong style="font-size: 15px; color: #111827;">📊 Network Coverage Analysis</strong>',
                    '',
                    `✓ Current network: ${uwPartners.length} partner hospitals`,
                    `✓ Geographic spread: ${uwPartners.filter(h => h.state === 'WA').length} WA, ${uwPartners.filter(h => h.state === 'ID').length} ID, ${uwPartners.filter(h => h.state === 'AK').length} AK`,
                    `✓ Combined ED volume: ${(uwPartners.reduce((sum, h) => sum + h.edVolume, 0) / 1000).toFixed(0)}K visits/yr`,
                    '',
                    '<strong>Coverage Gaps Identified:</strong>',
                    '• Eastern Washington (Spokane region)',
                    '• Olympic Peninsula',
                    '• North Cascades'
                ];

            } else if (mode === 'gaps') {
                insights = [
                    '<strong style="font-size: 15px; color: #111827;">🗺️ Coverage Gap Analysis</strong>',
                    '',
                    '<strong>Underserved Areas (>60 min from UW partner):</strong>',
                    '',
                    '📍 <strong>Olympic Peninsula</strong>',
                    '  • Forks Community Hospital (4.2K ED visits)',
                    '  • Olympic Medical Center (32K ED visits) - High priority',
                    '',
                    '📍 <strong>Eastern Washington</strong>',
                    '  • Multiple rural hospitals >90 min from coverage',
                    '  • Consider partnerships in Spokane vicinity',
                    '',
                    '📍 <strong>North Cascades</strong>',
                    '  • Limited access for rural populations',
                    '  • Cascade Medical Center already partnered ✓'
                ];

            } else if (mode === 'market') {
                const totalED = HOSPITALS.reduce((sum, h) => sum + h.edVolume, 0);
                const partnerED = HOSPITALS.filter(h => h.uwPartner).reduce((sum, h) => sum + h.edVolume, 0);
                const marketShare = (partnerED / totalED * 100).toFixed(1);

                insights = [
                    '<strong style="font-size: 15px; color: #111827;">💼 Market Penetration Analysis</strong>',
                    '',
                    `<strong>Current Market Share: ${marketShare}%</strong>`,
                    `(${(partnerED/1000).toFixed(0)}K of ${(totalED/1000).toFixed(0)}K total ED visits)`,
                    '',
                    '<strong>Growth Opportunities:</strong>',
                    `• Adding top 5 targets would increase share to ${((partnerED + HOSPITALS.filter(h => !h.uwPartner).sort((a,b) => b.opportunityScore.total - a.opportunityScore.total).slice(0,5).reduce((sum, h) => sum + h.edVolume, 0)) / totalED * 100).toFixed(1)}%`,
                    '• Focus on high-volume non-partner facilities',
                    '• Competitive positioning vs. Swedish, Providence networks'
                ];

            } else if (mode === 'competitor') {
                const competitorCSCs = HOSPITALS.filter(h => !h.uwPartner && h.type === 'CSC');
                insights = [
                    '<strong style="font-size: 15px; color: #111827;">🏥 Competitive Analysis</strong>',
                    '',
                    `<strong>Non-Partner CSCs: ${competitorCSCs.length}</strong>`,
                    '',
                    ...competitorCSCs.map(h =>
                        `• ${h.name} (${h.city}, ${h.state})<br>  ${h.edVolume.toLocaleString()} ED visits/yr`
                    ),
                    '',
                    '<strong>Strategic Implications:</strong>',
                    '• High competition in Seattle metro area',
                    '• Partnership opportunities in underserved regions',
                    '• Consider strategic alliances vs. competition'
                ];
            }

            document.getElementById('insights-content').innerHTML = insights.join('<br>');
        }

        // Update opportunities list
        function updateOpportunitiesList(hospitals) {
            const container = document.getElementById('opportunities-list');
            container.innerHTML = hospitals.map(h => {
                const scoreClass = h.opportunityScore.total >= 70 ? 'score-high' :
                                  h.opportunityScore.total >= 40 ? 'score-medium' : 'score-low';
                return `
                    <div class="opportunity-item" onclick="flyToHospital('${h.name}')">
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${h.name}</div>
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">${h.city}, ${h.state}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px;">${h.edVolume.toLocaleString()} ED/yr</span>
                            <span class="score-badge ${scoreClass}">${h.opportunityScore.total}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Fly to hospital
        function flyToHospital(name) {
            const layer = markerLayers[name];
            if (layer) {
                map.flyTo([layer.hospital.lat, layer.hospital.lng], 11);
                layer.marker.openPopup();
            }
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');

            // Auto-run analysis when switching to analysis tab
            if (tab === 'analysis') {
                setTimeout(runAnalysis, 100);
            }

            // Auto-update opportunities when switching to scenarios tab
            if (tab === 'scenarios') {
                const nonPartners = HOSPITALS.filter(h => !h.uwPartner);
                const sorted = nonPartners.sort((a, b) => b.opportunityScore.total - a.opportunityScore.total);
                updateOpportunitiesList(sorted.slice(0, 15));
            }
        }

        // Scenario functions
        function loadScenario() {
            const scenario = document.getElementById('scenario-select').value;
            console.log('Loading scenario:', scenario);
            alert(`Loading scenario: ${scenario}\n(Full implementation pending)`);
        }

        function saveScenario() {
            alert('Scenario saved successfully!\n(Full implementation pending)');
        }

        function compareScenarios() {
            alert('Opening scenario comparison view...\n(Full implementation pending)');
        }

        // Export functions
        function exportToExcel() {
            const data = HOSPITALS.map(h => ({
                'Hospital Name': h.name,
                'City': h.city,
                'State': h.state,
                'Type': h.type,
                'Stroke Level': h.strokeLevel || 'None',
                'National Certification': h.nationalCert || 'None',
                'WA State Stroke Level': h.waStateStroke || 'N/A',
                'UW Partner': h.uwPartner ? 'Yes' : 'No',
                'ED Volume': h.edVolume,
                'Distance from Hub (mi)': Math.round(h.distanceFromHub),
                'Opportunity Score': h.opportunityScore.total,
                'Nearest Partner (mi)': h.opportunityScore.nearestPartner
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Hospitals');

            // Add statistics sheet
            const stats = [
                { Metric: 'Total Hospitals', Value: HOSPITALS.length },
                { Metric: 'UW Partners', Value: HOSPITALS.filter(h => h.uwPartner).length },
                { Metric: 'Comprehensive Stroke Centers', Value: HOSPITALS.filter(h => h.type === 'CSC').length },
                { Metric: 'Primary Stroke Centers', Value: HOSPITALS.filter(h => h.type === 'PSC').length },
                { Metric: 'Total ED Volume', Value: HOSPITALS.reduce((sum, h) => sum + h.edVolume, 0) },
                { Metric: 'Analysis Date', Value: new Date().toLocaleDateString() }
            ];
            const ws2 = XLSX.utils.json_to_sheet(stats);
            XLSX.utils.book_append_sheet(wb, ws2, 'Statistics');

            XLSX.writeFile(wb, `telestroke-analysis-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportMapImage() {
            alert('Capturing map screenshot...\n(Preparing download)');

            html2canvas(document.getElementById('map'), {
                useCORS: true,
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `telestroke-map-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function exportDataJSON() {
            const data = {
                generated: new Date().toISOString(),
                hospitals: HOSPITALS,
                statistics: {
                    total: HOSPITALS.length,
                    uwPartners: HOSPITALS.filter(h => h.uwPartner).length,
                    csc: HOSPITALS.filter(h => h.type === 'CSC').length,
                    psc: HOSPITALS.filter(h => h.type === 'PSC').length,
                    totalEDVolume: HOSPITALS.reduce((sum, h) => sum + h.edVolume, 0)
                },
                weights: weights
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `telestroke-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function generateReport() {
            alert('Generating comprehensive report...\n\nReport will include:\n• Executive summary\n• Network analysis\n• Opportunity rankings\n• Coverage maps\n• Recommendations\n\n(Full PDF generation pending)');
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, initializing application...');

            addDistanceRings();
            addReferenceMarker();
            addHospitalMarkers();
            updateStatistics();
            runAnalysis(); // Run initial analysis

            console.log('Application initialized successfully');
        });
    </script>
</body>
</html>
